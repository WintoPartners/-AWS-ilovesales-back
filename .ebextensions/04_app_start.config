option_settings:
  aws:elasticbeanstalk:application:environment:
    IMWEB_API_KEY: ${{ secrets.IMWEB_API_KEY }}
    IMWEB_SECRET_KEY: ${{ secrets.IMWEB_SECRET_KEY }}
    ENVIRONMENT: "production"

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/run_app.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # 이전 프로세스 종료
      sudo kill -9 $(sudo lsof -t -i:8000) || true
      
      # virtualenv 활성화
      source /var/app/venv/*/bin/activate
      
      # 애플리케이션 디렉토리로 이동
      cd /var/app/current
      
      # 백그라운드에서 FastAPI 실행
      nohup uvicorn main:app --host 0.0.0.0 --port 8000 > /var/log/fastapi.log 2>&1 &
      
      # 프로세스가 시작될 때까지 대기
      sleep 5

container_commands:
  01_run_app:
    command: "chmod +x /opt/elasticbeanstalk/hooks/appdeploy/post/run_app.sh && /opt/elasticbeanstalk/hooks/appdeploy/post/run_app.sh"