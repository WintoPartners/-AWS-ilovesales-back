option_settings:
  aws:elasticbeanstalk:application:environment:
    IMWEB_API_KEY: ${{ secrets.IMWEB_API_KEY }}
    IMWEB_SECRET_KEY: ${{ secrets.IMWEB_SECRET_KEY }}
    ENVIRONMENT: "production"

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/run_app.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      echo "=== Starting deployment script ===" > /var/log/fastapi/app.log
      
      echo "Stopping existing processes..." >> /var/log/fastapi/app.log
      # 기존 프로세스 종료
      sudo pkill -9 gunicorn || true
      sudo systemctl stop gunicorn || true
      sudo kill -9 $(sudo lsof -t -i:8000) || true
      
      echo "Setting up log directory..." >> /var/log/fastapi/app.log
      # 로그 디렉토리 초기화
      sudo rm -rf /var/log/fastapi
      sudo mkdir -p /var/log/fastapi
      sudo chown -R webapp:webapp /var/log/fastapi
      
      echo "Checking environment variables..." >> /var/log/fastapi/app.log
      # 환경 변수 확인
      source /var/app/venv/*/bin/activate
      env | grep IMWEB >> /var/log/fastapi/app.log
      
      echo "Starting FastAPI application..." >> /var/log/fastapi/app.log
      # FastAPI 실행
      cd /var/app/current
      nohup uvicorn main:app --host 0.0.0.0 --port 8000 --reload >> /var/log/fastapi/app.log 2>&1 &
      
      # 상태 확인
      sleep 10
      echo "Checking process status..." >> /var/log/fastapi/app.log
      ps aux | grep uvicorn >> /var/log/fastapi/app.log
      netstat -tulpn | grep 8000 >> /var/log/fastapi/app.log
      
      echo "=== Deployment script completed ===" >> /var/log/fastapi/app.log

container_commands:
  01_stop_services:
    command: "sudo systemctl stop gunicorn || true"
  02_run_app:
    command: "chmod +x /opt/elasticbeanstalk/hooks/appdeploy/post/run_app.sh && /opt/elasticbeanstalk/hooks/appdeploy/post/run_app.sh"