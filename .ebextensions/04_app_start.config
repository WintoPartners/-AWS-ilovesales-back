option_settings:
  aws:elasticbeanstalk:application:environment:
    IMWEB_API_KEY: ${{ secrets.IMWEB_API_KEY }}
    IMWEB_SECRET_KEY: ${{ secrets.IMWEB_SECRET_KEY }}
    ENVIRONMENT: "production"

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/run_app.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # 모든 gunicorn 프로세스 강제 종료
      sudo pkill -9 gunicorn || true
      sudo systemctl stop gunicorn || true
      
      # 8000 포트 사용 중인 모든 프로세스 종료
      sudo kill -9 $(sudo lsof -t -i:8000) || true
      
      # 로그 디렉토리 및 파일 설정
      sudo mkdir -p /var/log/fastapi
      sudo touch /var/log/fastapi/app.log
      sudo chown -R webapp:webapp /var/log/fastapi
      
      # virtualenv 활성화 및 환경 변수 확인
      source /var/app/venv/*/bin/activate
      echo "Current environment variables:" >> /var/log/fastapi/app.log
      env | grep IMWEB >> /var/log/fastapi/app.log
      
      # 애플리케이션 디렉토리로 이동
      cd /var/app/current
      
      # FastAPI 실행
      nohup uvicorn main:app --host 0.0.0.0 --port 8000 > /var/log/fastapi/app.log 2>&1 &
      
      # 프로세스 확인을 위한 대기
      sleep 10
      
      # 상태 확인 및 로깅
      echo "Process status after startup:" >> /var/log/fastapi/app.log
      ps aux | grep uvicorn >> /var/log/fastapi/app.log
      netstat -tulpn | grep 8000 >> /var/log/fastapi/app.log

container_commands:
  01_stop_services:
    command: "sudo systemctl stop gunicorn || true"
  02_run_app:
    command: "chmod +x /opt/elasticbeanstalk/hooks/appdeploy/post/run_app.sh && /opt/elasticbeanstalk/hooks/appdeploy/post/run_app.sh"